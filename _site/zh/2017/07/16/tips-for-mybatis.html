<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Mybatis使用提示</title>
  <meta name="description" content="1. 使用注解方式生成Mapper时，不能有重名方法例子">
  <link href='https://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic|Source+Sans+Pro:400,700,200,300|Josefin+Sans:400,600,700,300' rel='stylesheet' type='text/css'>
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/style.css">
  <link rel="canonical" href="http://localhost:4000/zh/2017/07/16/tips-for-mybatis.html">
  <link rel="alternate" type="application/rss+xml" title="Optional<String>" href="http://localhost:4000/feed.xml">
</head>


    <body>

        <div class="wrapper">
    <div class="trigger site-navigation">
        <a class="page-link" href="http://localhost:4000/zh">HOME</a>

        
        
        <a class="site-language" href="/en/2017/07/16/tips-for-mybatis.html">ENGLISH</a>
        

        
        
        
        
        
        
        
        
        
    </div>
</div>

        <div class="page-content">
            <div class="wrapper">

                <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

                    <header class="post-header">
                        <h1 class="post-title" itemprop="name headline"><a class="post-title-link"  href="/zh/2017/07/16/tips-for-mybatis.html">Mybatis使用提示</a></h1>
                        <center>
                            <p class="post-meta">
                            <time datetime="2017-07-16T00:00:00+08:00" itemprop="datePublished">
                                
                                2017年07月16日
                                

                                
                            </time>
                            </p>
                            
                        </center>
                    </header>

                    
                    <div class="post-content-zh" itemprop="articleBody">
                    

                    

                        <h2 id="1-使用注解方式生成mapper时不能有重名方法">1. 使用注解方式生成Mapper时，不能有重名方法</h2>
<h3 id="例子">例子</h3>

<p>下面使用了Java方法重载来实现了两个命为<code class="highlighter-rouge">select</code>方法。</p>
<div class="highlighter-rouge"><pre class="highlight"><code>public interface TestDAO {
    @Select("SELECT COUNT(id) FROM table WHERE id = #{id}")
    int select(@Param("id") int id);

    @Delete("SELECT COUNT(id) FROM table WHERE id = #{id} AND id2 = #{id2}")
    int select(@Param("id") int id, @Param("id2") int id2);
}

</code></pre>
</div>

<p>运行时会报这个异常。</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Exception in thread "main" java.lang.IllegalArgumentException: Mapped Statements collection already contains value for dao.TestDAO.select
    at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:859)
    at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:831)
    at org.apache.ibatis.session.Configuration.addMappedStatement(Configuration.java:655)
    at org.apache.ibatis.builder.MapperBuilderAssistant.addMappedStatement(MapperBuilderAssistant.java:302)
    at org.apache.ibatis.builder.annotation.MapperAnnotationBuilder.parseStatement(MapperAnnotationBuilder.java:351)
    at org.apache.ibatis.builder.annotation.MapperAnnotationBuilder.parse(MapperAnnotationBuilder.java:134)
    at org.apache.ibatis.binding.MapperRegistry.addMapper(MapperRegistry.java:72)
    at org.apache.ibatis.session.Configuration.addMapper(Configuration.java:728)
</code></pre>
</div>

<p>原因是什么呢？我们从源码来看一下。下面是<code class="highlighter-rouge">Configuration.java:655</code>这行代码。我们发现Myatis将<code class="highlighter-rouge">ms.getId()</code>当作key放到了StrictMap中，从而导致了StrictMap抛出异常。</p>
<div class="highlighter-rouge"><pre class="highlight"><code>//at org.apache.ibatis.session.Configuration.addMappedStatement(Configuration.java:655)
public void addMappedStatement(MappedStatement ms) {
    mappedStatements.put(ms.getId(), ms);
}
</code></pre>
</div>

<p>继续查找源码发现有两个地方生成MappedStatement的id。
第一个是<code class="highlighter-rouge">XMLStatementBuilder:57</code>，<code class="highlighter-rouge">String id = context.getStringAttribute("id");</code>。是XML解析的时候，获取id属性上的字符串来作为key。
第二个是<code class="highlighter-rouge">MapperAnnotationBuilder:292</code>,<code class="highlighter-rouge"> final String mappedStatementId = type.getName() + "." + method.getName();</code>。是通过注解生成Mapper时，将Mapper类名加上方法名作为id，并没有将方法参数作为id的一部分，所以导致了上述异常。</p>

                    </div>
                </article>
            </div>
        </div>
    </body>
</html>
