---
layout: post
title: 分层架构理论和实践
categories: zh
category: zh
tag: 分层架构 实践

---

## 前言
本文首先简单讲述一下分层架构的理论，而后讲述在实践中遇到的问题和解决方案。

## 理论
对分层架构一直不是特别了解。在网上也看过一些文章，这些问题章也讲的比较浅。
最近看到了一本书--《面向模式的软件架构：模式系统》，书中对于分层架构的分析十分详细。推荐给所有想要了解分层架构的人。

我将书中的实现、优点和缺点摘抄下来。由于本文主要讲实践中遇到的问题和解决方案，所以对于一下内容不再做详细解释。感兴趣的可以去书中查看。

### 实现
1. 定义将任务划分到不同层的抽象准则。
2. 根据抽象准则确定抽象层级数。
3. 给每层命名并分派任务。
4. 规范服务。
5. 完善层次划分。反复执行1～4步。
6. 规范每层的接口。
7. 确定各层的结构。
8. 规范相邻层之间的通信。
9. 将相邻层解耦。
10. 制定错误处理策略。

### 优点
1. 各层重用。
2. 支持标准化。
3. 限制了依赖关系的范围。
4. 可更换型。

### 缺点
1. 行为变化可能引发雪崩。
2. 效率低下。
3. 不必要的工作。
4. 难以确定的层次粒度。

## 实践

自工作以来，经历过的项目大多都是用的分层架构，基本上就是这种结构。

表现层  
业务逻辑层
数据库层

### 遇到的问题
在使用分层架构时，遇到得最大的问题是Service层中的网状或循环引用。它表现如下，现实情况比这个更加复杂。
~~~
class AService{
  @Autowire
  private BService b;
}

class BService{
  @Autowire
  private CService c;
}

class CService{
  @Autowire
  private AService a;
  
  @Autowire
  private CService c;//没错，就是引用自己
}
~~~

由于Service层的类都交织在一起，所以后期拆是不可能的。下面讲一下我具体遇到的问题。

#### 按照业务拆分很难
业务量小的时候，所有的代码都写在一个project中，现在业务量大了，要按照业务拆分。

由于Service层的类交织在一起，所以现在有两个方案：

1. 各个业务重写Service
2. 将Service打包，各个业务启动的时候，初始化所有的bean。
3. 将Service打包，各个业务启动的时候，让bean懒加载。

如果使用方案#2，要将所有的bean初始化，有的bean会在初始化时连接数据库或其他耗时操作，这样会导致启动时间变得很长。

如果使用方案#3，虽然可以避免初始化时间过长，但是因为是懒加载，在重启服务后，最先到达的部分流量会相应时间很长。

最后，不过是#2还是#3，不仅是要初始化bean，所有的配置文件，也一个都不能落下。因为你不知道会涉及到哪个类的配置文件。


#### 不管合适不合适，有业务逻辑的类都叫XXService
不管封装第三方API还是封装CacheClient，都把它们配分给Service。


### 问题分析
第一个问题，我认为是实现中的#7，确定各层的结构，没有做好。虽然是分层了，但是层内的结构结构确实混乱的。

第二个问题，很显然后没有把层次划分好。业务小的时候，三层没有问题，但是当业务已经需要依赖到多个其他API或业务，那么三层显然已经不合适。

### 解决方案
对于第一个问题，直接Service类禁止调用其他接Service接口。对于通用的逻辑，则可以通过重新划分层次来解决。

对于第二个问题，则需要重新划分层次。我推荐阿里发布的([《阿里巴巴Java开发手册（正式版）》](https://yq.aliyun.com/articles/69327)中的分层。我将相关部分引用到下面。

>图中默认上层依赖于下层，箭头关系表示可直接依赖，如:开放接口层可以依赖于 Web 层，也可以直接依赖于 Service 层，依此类推: 

>![分层架构](/public/imgs/ali-layers.png){: width="500px"}

>开放接口层:可直接封装 Service 方法暴露成 RPC 接口;通过 Web 封装成 http 接口;进行 网关安全控制、流量控制等。 

>终端显示层:各个端的模板渲染并执行显示的层。当前主要是 velocity 渲染，JS 渲染， JSP 渲染，移动端展示等。 

>Web 层:主要是对访问控制进行转发，各类基本参数校验，或者不复用的业务简单处理等。 

>Service 层:相对具体的业务逻辑服务层。 

>Manager 层:通用业务处理层，它有如下特征:
>1. 对第三方平台封装的层，预处理返回结果及转化异常信息;
>2. 对Service层通用能力的下沉，如缓存方案、中间件通用处理;
>3. 与DAO层交互，对多个DAO的组合复用。 

>DAO 层:数据访问层，与底层 MySQL、Oracle、Hbase 进行数据交互。 

>外部接口或第三方平台:包括其它部门RPC开放接口，基础平台，其它公司的HTTP接口。 

## 最后
最近拆分业务时，实践上面两条，代码的可维护行显然提高了很多。
